{% extends "base.html" %}

{% block title %}–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Äî Borodach Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ü©∫ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h1>
    <button onclick="runDiagnostics()" class="btn btn-primary" id="runBtn">
        üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
    </button>
</div>

<p class="description">
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.
</p>

<div class="diagnostics-grid" id="diagnosticsGrid">
    <!-- Database -->
    <div class="diagnostic-card" id="card-database">
        <div class="diagnostic-icon">üóÑÔ∏è</div>
        <div class="diagnostic-info">
            <div class="diagnostic-name">PostgreSQL</div>
            <div class="diagnostic-desc">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</div>
        </div>
        <div class="diagnostic-status" id="status-database">
            <span class="status-pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</span>
        </div>
    </div>
    
    <!-- Redis -->
    <div class="diagnostic-card" id="card-redis">
        <div class="diagnostic-icon">üî¥</div>
        <div class="diagnostic-info">
            <div class="diagnostic-name">Redis</div>
            <div class="diagnostic-desc">–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
        </div>
        <div class="diagnostic-status" id="status-redis">
            <span class="status-pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</span>
        </div>
    </div>
    
    <!-- Telegram Bot -->
    <div class="diagnostic-card" id="card-telegram">
        <div class="diagnostic-icon">ü§ñ</div>
        <div class="diagnostic-info">
            <div class="diagnostic-name">Telegram Bot</div>
            <div class="diagnostic-desc">–ë–æ—Ç API</div>
        </div>
        <div class="diagnostic-status" id="status-telegram">
            <span class="status-pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</span>
        </div>
    </div>
    
    <!-- YClients API -->
    <div class="diagnostic-card" id="card-yclients">
        <div class="diagnostic-icon">üíà</div>
        <div class="diagnostic-info">
            <div class="diagnostic-name">YClients API</div>
            <div class="diagnostic-desc">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–∞–ª–æ–Ω–æ–≤</div>
        </div>
        <div class="diagnostic-status" id="status-yclients">
            <span class="status-pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</span>
        </div>
    </div>
    
    <!-- Bitrix API -->
    <div class="diagnostic-card" id="card-bitrix">
        <div class="diagnostic-icon">üìã</div>
        <div class="diagnostic-info">
            <div class="diagnostic-name">Bitrix24 API</div>
            <div class="diagnostic-desc">–°–∏—Å—Ç–µ–º–∞ –∑–∞–¥–∞—á</div>
        </div>
        <div class="diagnostic-status" id="status-bitrix">
            <span class="status-pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</span>
        </div>
    </div>
    
    <!-- Scheduler -->
    <div class="diagnostic-card" id="card-scheduler">
        <div class="diagnostic-icon">‚è∞</div>
        <div class="diagnostic-info">
            <div class="diagnostic-name">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</div>
            <div class="diagnostic-desc">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>
        </div>
        <div class="diagnostic-status" id="status-scheduler">
            <span class="status-pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</span>
        </div>
    </div>
</div>

<!-- –î–µ—Ç–∞–ª–∏ -->
<div class="card" id="detailsCard" style="display: none;">
    <div class="card-header">
        <h2 class="card-title">üìã –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
    </div>
    <div id="detailsContent"></div>
</div>

<!-- –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å -->
<div class="summary-card" id="summaryCard" style="display: none;">
    <div class="summary-icon" id="summaryIcon">‚úÖ</div>
    <div class="summary-text" id="summaryText">–í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ</div>
</div>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.description {
    color: var(--text-muted);
    margin-bottom: 2rem;
}

.diagnostics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.diagnostic-card {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 1.25rem;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s;
}

.diagnostic-card.checking {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-light);
}

.diagnostic-card.success {
    border-color: var(--success);
    background: linear-gradient(135deg, var(--bg-card) 0%, var(--success-light) 100%);
}

.diagnostic-card.error {
    border-color: var(--danger);
    background: linear-gradient(135deg, var(--bg-card) 0%, var(--danger-light) 100%);
}

.diagnostic-card.warning {
    border-color: var(--warning);
    background: linear-gradient(135deg, var(--bg-card) 0%, var(--warning-light) 100%);
}

.diagnostic-icon {
    font-size: 2rem;
    width: 3rem;
    text-align: center;
}

.diagnostic-info {
    flex: 1;
}

.diagnostic-name {
    font-weight: 600;
    font-size: 1rem;
}

.diagnostic-desc {
    color: var(--text-muted);
    font-size: 0.8125rem;
}

.diagnostic-status {
    text-align: right;
    min-width: 120px;
}

.status-pending { color: var(--text-muted); }
.status-checking { color: var(--accent); font-weight: 500; }
.status-ok { color: var(--success); font-weight: 600; }
.status-error { color: var(--danger); font-weight: 600; }
.status-warning { color: var(--warning); font-weight: 600; }

.status-detail {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.summary-card {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 2rem;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 1.5rem;
}

.summary-card.all-ok {
    border-color: var(--success);
    background: linear-gradient(135deg, var(--bg-card) 0%, var(--success-light) 100%);
}

.summary-card.has-errors {
    border-color: var(--danger);
    background: linear-gradient(135deg, var(--bg-card) 0%, var(--danger-light) 100%);
}

.summary-card.has-warnings {
    border-color: var(--warning);
    background: linear-gradient(135deg, var(--bg-card) 0%, var(--warning-light) 100%);
}

.summary-icon {
    font-size: 2.5rem;
}

.summary-text {
    font-size: 1.125rem;
    font-weight: 600;
}

#detailsContent {
    font-family: 'SF Mono', 'Menlo', monospace;
    font-size: 0.8125rem;
    line-height: 1.8;
}

.detail-row {
    display: flex;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    width: 150px;
    color: var(--text-muted);
}

.detail-value {
    flex: 1;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.checking .diagnostic-icon {
    animation: pulse 1s infinite;
}
</style>

<script>
async function runDiagnostics() {
    const btn = document.getElementById('runBtn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã
    const components = ['database', 'redis', 'telegram', 'yclients', 'bitrix', 'scheduler'];
    components.forEach(c => {
        document.getElementById(`card-${c}`).className = 'diagnostic-card';
        document.getElementById(`status-${c}`).innerHTML = '<span class="status-pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</span>';
    });
    
    document.getElementById('detailsCard').style.display = 'none';
    document.getElementById('summaryCard').style.display = 'none';
    
    try {
        const response = await fetch('/diagnostics/run');
        const data = await response.json();
        
        let allOk = true;
        let hasWarnings = false;
        let details = [];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
        for (const [key, result] of Object.entries(data.checks)) {
            const card = document.getElementById(`card-${key}`);
            const status = document.getElementById(`status-${key}`);
            
            if (result.status === 'ok') {
                card.className = 'diagnostic-card success';
                status.innerHTML = `<div class="status-ok">‚úÖ OK</div>
                    <div class="status-detail">${result.message || ''}</div>`;
            } else if (result.status === 'warning') {
                card.className = 'diagnostic-card warning';
                status.innerHTML = `<div class="status-warning">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</div>
                    <div class="status-detail">${result.message || ''}</div>`;
                hasWarnings = true;
            } else {
                card.className = 'diagnostic-card error';
                status.innerHTML = `<div class="status-error">‚ùå –û—à–∏–±–∫–∞</div>
                    <div class="status-detail">${result.message || ''}</div>`;
                allOk = false;
            }
            
            details.push({
                name: result.name,
                status: result.status,
                message: result.message,
                details: result.details
            });
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
        const detailsHtml = details.map(d => `
            <div class="detail-row">
                <div class="detail-label">${d.name}</div>
                <div class="detail-value">
                    ${d.status === 'ok' ? '‚úÖ' : d.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå'} 
                    ${d.message}
                    ${d.details ? `<br><span style="color: var(--text-muted)">${d.details}</span>` : ''}
                </div>
            </div>
        `).join('');
        
        document.getElementById('detailsContent').innerHTML = detailsHtml;
        document.getElementById('detailsCard').style.display = 'block';
        
        // –ò—Ç–æ–≥
        const summary = document.getElementById('summaryCard');
        const summaryIcon = document.getElementById('summaryIcon');
        const summaryText = document.getElementById('summaryText');
        
        if (allOk && !hasWarnings) {
            summary.className = 'summary-card all-ok';
            summaryIcon.textContent = '‚úÖ';
            summaryText.textContent = `–í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ (${data.timestamp})`;
        } else if (allOk && hasWarnings) {
            summary.className = 'summary-card has-warnings';
            summaryIcon.textContent = '‚ö†Ô∏è';
            summaryText.textContent = '–ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, –Ω–æ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç';
        } else {
            summary.className = 'summary-card has-errors';
            summaryIcon.textContent = '‚ùå';
            summaryText.textContent = '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã!';
        }
        
        summary.style.display = 'flex';
        
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É';
    }
}

// –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    runDiagnostics();
});
</script>
{% endblock %}

