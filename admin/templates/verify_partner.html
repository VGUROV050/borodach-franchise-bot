{% extends "base.html" %}

{% block title %}–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Äî {{ partner.full_name }}{% endblock %}

{% block content %}
<style>
    .search-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 0.75rem;
    }
    .company-list {
        max-height: 400px;
        overflow-y: auto;
        background: var(--bg-main);
        border-radius: 8px;
        padding: 0.5rem;
    }
    .company-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-radius: 6px;
        transition: background 0.2s;
    }
    .company-item:hover {
        background: var(--border);
    }
    .company-item input {
        width: 18px;
        height: 18px;
        accent-color: var(--accent);
    }
    .company-city {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-left: 0.5rem;
    }
    .company-id {
        font-size: 0.7rem;
        color: var(--text-muted);
        font-family: monospace;
    }
</style>

<h1 class="mb-2">‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞</h1>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">{{ partner.full_name }}</h2>
        <span class="badge badge-pending">–û–∂–∏–¥–∞–µ—Ç</span>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div>
            <h3 class="mb-1" style="font-size: 1rem; color: var(--text-muted);">üìã –î–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</h3>
            
            <table style="width: 100%;">
                <tr>
                    <td class="text-muted" style="width: 140px;">Telegram ID:</td>
                    <td><code>{{ partner.telegram_id }}</code></td>
                </tr>
                <tr>
                    <td class="text-muted">Username:</td>
                    <td>@{{ partner.telegram_username or '‚Äî' }}</td>
                </tr>
                <tr>
                    <td class="text-muted">–¢–µ–ª–µ—Ñ–æ–Ω:</td>
                    <td><strong>{{ partner.phone or '‚Äî' }}</strong></td>
                </tr>
                <tr>
                    <td class="text-muted">–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</td>
                    <td>{{ partner.created_at.strftime('%d.%m.%Y %H:%M') if partner.created_at else '‚Äî' }}</td>
                </tr>
            </table>
            
            {% if partner.branches_text %}
            <div class="partner-branches mt-2">
                <strong>üíà –ë–∞—Ä–±–µ—Ä—à–æ–ø—ã (—Ç–µ–∫—Å—Ç –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞):</strong>
                <pre style="margin-top: 0.5rem; background: var(--bg-main); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">{{ partner.branches_text }}</pre>
            </div>
            {% endif %}
        </div>
        
        <div>
            <h3 class="mb-1" style="font-size: 1rem; color: var(--text-muted);">üîó –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –±–∞—Ä–±–µ—Ä—à–æ–ø–∞–º</h3>
            
            <form method="post" action="/partners/{{ partner.id }}/verify">
                {% if companies %}
                <p class="text-muted mb-1" style="font-size: 0.9rem;">
                    –í—ã–±–µ—Ä–∏—Ç–µ –±–∞—Ä–±–µ—Ä—à–æ–ø—ã, –∫ –∫–æ—Ç–æ—Ä—ã–º –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ø–∞—Ä—Ç–Ω—ë—Ä:
                </p>
                
                <input type="text" id="companySearch" class="search-input" 
                       placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –≥–æ—Ä–æ–¥—É...">
                
                <div class="company-list" id="companyList">
                    {% for company in companies %}
                    <label class="company-item" 
                           data-name="{{ company.name|lower }}" 
                           data-city="{{ (company.city or '')|lower }}">
                        <input type="checkbox" name="company_ids" value="{{ company.id }}">
                        <span>
                            <strong>{{ company.name }}</strong>
                            {% if company.city %}
                            <span class="company-city">{{ company.city }}</span>
                            {% endif %}
                            <br>
                            <span class="company-id">ID: {{ company.yclients_id }}</span>
                        </span>
                    </label>
                    {% endfor %}
                </div>
                
                <div class="text-muted mt-1" style="font-size: 0.85rem;">
                    –í—Å–µ–≥–æ —Å–∞–ª–æ–Ω–æ–≤: {{ companies|length }}
                    | <a href="/yclients-companies/sync" style="color: var(--accent);">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</a>
                </div>
                
                {% else %}
                <div class="alert" style="background: var(--warning-light); border: 1px solid var(--warning); padding: 1rem; border-radius: 8px;">
                    ‚ö†Ô∏è –°–∞–ª–æ–Ω—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. 
                    <a href="/yclients-companies" style="color: var(--accent);">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑ YClients</a>
                </div>
                {% endif %}
                
                <div class="mt-2 flex gap-1">
                    <button type="submit" class="btn btn-success">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</button>
                    <a href="/" class="btn">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="card mt-2">
    <h3 style="font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem;">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</h3>
    
    <form method="post" action="/partners/{{ partner.id }}/reject">
        <div class="form-group">
            <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="text" name="reason" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ">
        </div>
        <button type="submit" class="btn btn-danger">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    </form>
</div>

<script>
// –ü–æ–∏—Å–∫ –ø–æ —Å–ø–∏—Å–∫—É —Å–∞–ª–æ–Ω–æ–≤
document.getElementById('companySearch')?.addEventListener('input', function() {
    const query = this.value.toLowerCase();
    const items = document.querySelectorAll('.company-item');
    
    items.forEach(item => {
        const name = item.dataset.name || '';
        const city = item.dataset.city || '';
        const matches = name.includes(query) || city.includes(query);
        item.style.display = matches ? '' : 'none';
    });
});
</script>
{% endblock %}
