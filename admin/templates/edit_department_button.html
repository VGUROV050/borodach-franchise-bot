{% extends "base.html" %}

{% block title %}{% if is_new %}–ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏{% endif %} ‚Äî –ê–¥–º–∏–Ω–∫–∞{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        {% if is_new %}‚ûï –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞{% else %}‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏{% endif %}
    </h1>
    <a href="/useful-info/buttons" class="btn">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<div class="card">
    <form method="post" action="{% if is_new %}/useful-info/buttons/create{% else %}/useful-info/buttons/{{ button.id }}/edit{% endif %}">
        <div style="padding: 1.5rem; display: grid; gap: 1.5rem;">
            
            <!-- –û—Ç–¥–µ–ª -->
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–û—Ç–¥–µ–ª</label>
                <select name="department" required 
                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    {% for dept in DepartmentType %}
                    <option value="{{ dept.value }}" 
                            {% if selected_department == dept.value or (button and button.department == dept) %}selected{% endif %}>
                        {% if dept.value == 'development' %}üöÄ –û—Ç–¥–µ–ª –†–∞–∑–≤–∏—Ç–∏—è
                        {% elif dept.value == 'marketing' %}üì¢ –û—Ç–¥–µ–ª –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞  
                        {% elif dept.value == 'design' %}üé® –û—Ç–¥–µ–ª –î–∏–∑–∞–π–Ω–∞
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ -->
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏</label>
                <input type="text" name="button_text" required maxlength="100"
                       value="{% if button %}{{ button.button_text }}{% endif %}"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ—Ç–∫—Ä—ã—Ç–∏—é"
                       style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                <small style="color: var(--text-muted);">–¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –∫–Ω–æ–ø–∫–µ (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤)</small>
            </div>
            
            <!-- –ü–æ—Ä—è–¥–æ–∫ -->
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                <input type="number" name="order" min="0" max="999"
                       value="{% if button %}{{ button.order }}{% else %}0{% endif %}"
                       style="width: 100px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">–ú–µ–Ω—å—à–µ —á–∏—Å–ª–æ = –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ</small>
            </div>
            
            {% if not is_new %}
            <!-- –°—Ç–∞—Ç—É—Å -->
            <div>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="is_active" value="true"
                           {% if button.is_active %}checked{% endif %}
                           style="width: 20px; height: 20px;">
                    <span style="font-weight: 600;">–ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
                </label>
                <small style="color: var(--text-muted);">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –±–æ—Ç–µ</small>
            </div>
            {% endif %}
            
            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ -->
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏</label>
                
                <!-- Toolbar -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                    <button type="button" onclick="wrapText('b')" class="format-btn" title="–ñ–∏—Ä–Ω—ã–π">
                        <b>B</b>
                    </button>
                    <button type="button" onclick="wrapText('i')" class="format-btn" title="–ö—É—Ä—Å–∏–≤">
                        <i>I</i>
                    </button>
                    <button type="button" onclick="wrapText('u')" class="format-btn" title="–ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π">
                        <u>U</u>
                    </button>
                    <button type="button" onclick="wrapText('s')" class="format-btn" title="–ó–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π">
                        <s>S</s>
                    </button>
                    <button type="button" onclick="wrapText('code')" class="format-btn" title="–ö–æ–¥">
                        &lt;/&gt;
                    </button>
                    <button type="button" onclick="insertLink()" class="format-btn" title="–°—Å—ã–ª–∫–∞">
                        üîó
                    </button>
                    <button type="button" onclick="insertNewline()" class="format-btn" title="–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞">
                        ‚Üµ
                    </button>
                </div>
                
                <textarea id="message_text" name="message_text" required
                          rows="8" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: monospace; resize: vertical;">{% if button %}{{ button.message_text }}{% endif %}</textarea>
                
                <small style="color: var(--text-muted);">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML: &lt;b&gt;, &lt;i&gt;, &lt;u&gt;, &lt;s&gt;, &lt;code&gt;, &lt;a href=""&gt;</small>
            </div>
            
            <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</label>
                <div id="preview" style="background: #e5ddd5; padding: 1rem; border-radius: 12px; min-height: 60px;">
                    <div style="background: #dcf8c6; padding: 0.75rem 1rem; border-radius: 8px; max-width: 80%; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1);">
                        <div id="preview-content" style="white-space: pre-wrap; line-height: 1.5;"></div>
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div style="display: flex; gap: 1rem; justify-content: flex-end; border-top: 1px solid var(--border); padding-top: 1.5rem;">
                <a href="/useful-info/buttons" class="btn" style="background: var(--card-bg); border: 1px solid var(--border);">
                    –û—Ç–º–µ–Ω–∞
                </a>
                <button type="submit" class="btn btn-success">
                    {% if is_new %}–°–æ–∑–¥–∞—Ç—å –∫–Ω–æ–ø–∫—É{% else %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

<style>
.format-btn {
    padding: 0.5rem 0.75rem;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    min-width: 36px;
    transition: all 0.2s;
}
.format-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
</style>

<script>
const textarea = document.getElementById('message_text');
const preview = document.getElementById('preview-content');

function updatePreview() {
    let text = textarea.value;
    preview.innerHTML = text || '<span style="color: #999;">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...</span>';
}

textarea.addEventListener('input', updatePreview);
updatePreview();

function wrapText(tag) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    const replacement = `<${tag}>${selectedText}</${tag}>`;
    
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
    textarea.setSelectionRange(start + tag.length + 2, start + tag.length + 2 + selectedText.length);
    updatePreview();
}

function insertLink() {
    const url = prompt('–í–≤–µ–¥–∏—Ç–µ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://t.me/username):');
    if (!url) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end) || '—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏';
    const replacement = `<a href="${url}">${selectedText}</a>`;
    
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
    updatePreview();
}

function insertNewline() {
    const start = textarea.selectionStart;
    textarea.value = textarea.value.substring(0, start) + '\n' + textarea.value.substring(start);
    textarea.focus();
    textarea.setSelectionRange(start + 1, start + 1);
    updatePreview();
}
</script>
{% endblock %}

