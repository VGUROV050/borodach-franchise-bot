{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî {{ partner.full_name }}{% endblock %}

{% block content %}
<style>
    .company-list {
        max-height: 400px;
        overflow-y: auto;
        background: var(--bg-main);
        border-radius: 8px;
        padding: 0.5rem;
    }
    .company-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-radius: 6px;
        transition: background 0.2s;
    }
    .company-item:hover {
        background: var(--border);
    }
    .company-item input {
        width: 18px;
        height: 18px;
        accent-color: var(--accent);
    }
    .search-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 0.75rem;
    }
    .linked-companies {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .linked-company-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--success-light);
        color: #047857;
        border-radius: 6px;
        font-size: 0.875rem;
    }
</style>

<h1 class="mb-2">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</h1>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">{{ partner.full_name }}</h2>
        <span class="badge {% if partner.status.value == 'verified' %}badge-verified{% elif partner.status.value == 'pending' %}badge-pending{% else %}badge-rejected{% endif %}">
            {{ partner.status.value }}
        </span>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; padding: 1.5rem;">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ä—Ç–Ω—ë—Ä–µ -->
        <div>
            <h3 style="font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem;">üìã –î–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</h3>
            
            <table style="width: 100%;">
                <tr>
                    <td class="text-muted" style="width: 140px; padding: 0.5rem 0;">Telegram ID:</td>
                    <td style="padding: 0.5rem 0;"><code>{{ partner.telegram_id }}</code></td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 0.5rem 0;">Username:</td>
                    <td style="padding: 0.5rem 0;">@{{ partner.telegram_username or '‚Äî' }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 0.5rem 0;">–¢–µ–ª–µ—Ñ–æ–Ω:</td>
                    <td style="padding: 0.5rem 0;"><strong>{{ partner.phone or '‚Äî' }}</strong></td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 0.5rem 0;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</td>
                    <td style="padding: 0.5rem 0;">{{ partner.created_at.strftime('%d.%m.%Y %H:%M') if partner.created_at else '‚Äî' }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 0.5rem 0;">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:</td>
                    <td style="padding: 0.5rem 0;">{{ partner.verified_at.strftime('%d.%m.%Y %H:%M') if partner.verified_at else '‚Äî' }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 0.5rem 0;">–†–æ–ª—å:</td>
                    <td style="padding: 0.5rem 0;">
                        {% if partner.is_owner %}
                        <span class="badge badge-success">üëë –í–ª–∞–¥–µ–ª–µ—Ü</span>
                        {% else %}
                        <span class="badge badge-info">üë§ {{ partner.position or '–°–æ—Ç—Ä—É–¥–Ω–∏–∫' }}</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
            
            <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-main); border-radius: 8px;">
                <strong class="text-muted">üëî –ò–∑–º–µ–Ω–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å:</strong>
                <form method="post" action="/partners/{{ partner.id }}/update-position" style="margin-top: 0.75rem;">
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="is_owner" value="1" {% if partner.is_owner %}checked{% endif %}
                                   onchange="document.getElementById('positionField').style.display = this.checked ? 'none' : 'flex';">
                            –í–ª–∞–¥–µ–ª–µ—Ü
                        </label>
                    </div>
                    <div id="positionField" style="display: {% if partner.is_owner %}none{% else %}flex{% endif %}; gap: 0.5rem; align-items: center;">
                        <input type="text" name="position" value="{{ partner.position or '' }}" 
                               class="form-input" placeholder="–£–ø—Ä–∞–≤–ª—è—é—â–∏–π, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä..." style="flex: 1;">
                    </div>
                    <button type="submit" class="btn btn-sm mt-1">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å</button>
                </form>
            </div>
            
            {% if partner.branches_text %}
            <div style="margin-top: 1rem;">
                <strong class="text-muted">–¢–µ–∫—Å—Ç –±–∞—Ä–±–µ—Ä—à–æ–ø–æ–≤ –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞:</strong>
                <pre style="margin-top: 0.5rem; background: var(--bg-main); padding: 1rem; border-radius: 8px; white-space: pre-wrap; font-size: 0.85rem;">{{ partner.branches_text }}</pre>
            </div>
            {% endif %}
            
            <!-- –¢–µ–∫—É—â–∏–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –±–∞—Ä–±–µ—Ä—à–æ–ø—ã -->
            <div style="margin-top: 1.5rem;">
                <strong class="text-muted">–ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –±–∞—Ä–±–µ—Ä—à–æ–ø—ã:</strong>
                {% if linked_companies %}
                <div class="linked-companies">
                    {% for company in linked_companies %}
                    <span class="linked-company-badge">
                        ‚úÖ {{ company.name }}
                        {% if company.city %}<small>({{ company.city }})</small>{% endif %}
                    </span>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-muted" style="margin-top: 0.5rem;">–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –±–∞—Ä–±–µ—Ä—à–æ–ø–æ–≤</div>
                {% endif %}
            </div>
        </div>
        
        <!-- –í—ã–±–æ—Ä –±–∞—Ä–±–µ—Ä—à–æ–ø–æ–≤ -->
        <div>
            <h3 style="font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem;">üîó –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –±–∞—Ä–±–µ—Ä—à–æ–ø–∞–º</h3>
            
            <form method="post" action="/partners/{{ partner.id }}/edit">
                {% if companies %}
                <p class="text-muted mb-1" style="font-size: 0.9rem;">
                    –í—ã–±–µ—Ä–∏—Ç–µ –±–∞—Ä–±–µ—Ä—à–æ–ø—ã –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞:
                </p>
                
                <input type="text" id="companySearch" class="search-input" 
                       placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –≥–æ—Ä–æ–¥—É...">
                
                <div class="company-list" id="companyList">
                    {% for company in companies %}
                    <label class="company-item" 
                           data-name="{{ company.name|lower }}" 
                           data-city="{{ (company.city or '')|lower }}">
                        <input type="checkbox" name="company_ids" value="{{ company.id }}"
                               {% if company.id in linked_company_ids %}checked{% endif %}>
                        <span>
                            <strong>{{ company.name }}</strong>
                            {% if company.city %}
                            <span style="color: var(--text-muted); font-size: 0.85rem;">({{ company.city }})</span>
                            {% endif %}
                        </span>
                    </label>
                    {% endfor %}
                </div>
                
                <div class="text-muted mt-1" style="font-size: 0.85rem;">
                    –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∞–ª–æ–Ω–æ–≤: {{ companies|length }}
                </div>
                {% else %}
                <div class="alert" style="background: var(--warning-light); border: 1px solid var(--warning); padding: 1rem; border-radius: 8px;">
                    ‚ö†Ô∏è –°–∞–ª–æ–Ω—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. 
                    <a href="/yclients-companies" style="color: var(--accent);">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑ YClients</a>
                </div>
                {% endif %}
                
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    <a href="/partners" class="btn">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// –ü–æ–∏—Å–∫ –ø–æ —Å–ø–∏—Å–∫—É —Å–∞–ª–æ–Ω–æ–≤
document.getElementById('companySearch')?.addEventListener('input', function() {
    const query = this.value.toLowerCase();
    const items = document.querySelectorAll('.company-item');
    
    items.forEach(item => {
        const name = item.dataset.name || '';
        const city = item.dataset.city || '';
        const matches = name.includes(query) || city.includes(query);
        item.style.display = matches ? '' : 'none';
    });
});
</script>
{% endblock %}

