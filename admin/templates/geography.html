{% extends "base.html" %}

{% block title %}–ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Å–µ—Ç–∏ ‚Äî Borodach Admin{% endblock %}

{% block content %}
<style>
    .expandable-row {
        cursor: pointer;
        transition: background 0.2s;
    }
    .expandable-row:hover {
        background: var(--bg-main) !important;
    }
    .expand-icon {
        display: inline-block;
        width: 20px;
        transition: transform 0.2s;
    }
    .expand-icon.expanded {
        transform: rotate(90deg);
    }
    .salons-list {
        display: none;
        background: var(--bg-main);
        border-radius: 8px;
        margin: 0.5rem 0;
        padding: 0.75rem;
    }
    .salons-list.show {
        display: block;
    }
    .salon-item {
        display: flex;
        justify-content: space-between;
        padding: 0.375rem 0.5rem;
        border-bottom: 1px solid var(--border);
        font-size: 0.8125rem;
    }
    .salon-item:last-child {
        border-bottom: none;
    }
    .salon-name {
        color: var(--text);
        flex: 1;
    }
    .salon-rank {
        color: var(--text-muted);
        margin-right: 1rem;
        min-width: 50px;
    }
    .salon-revenue {
        color: var(--success);
        font-weight: 500;
        min-width: 100px;
        text-align: right;
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>üó∫ –ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Å–µ—Ç–∏</h1>
</div>

<!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
    <div class="stat-card">
        <div class="stat-value">{{ geo.total_salons }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ —Å–∞–ª–æ–Ω–æ–≤</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: var(--accent);">{{ geo.millionniki_count }}</div>
        <div class="stat-label">–í –º–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∞—Ö ({{ geo.millionniki_percent }}%)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: var(--warning);">{{ geo.other_count }}</div>
        <div class="stat-label">–í –¥—Ä—É–≥–∏—Ö –≥–æ—Ä–æ–¥–∞—Ö ({{ geo.other_percent }}%)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: var(--success);">{{ geo.by_city|length }}</div>
        <div class="stat-label">–ì–æ—Ä–æ–¥–æ–≤ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è</div>
    </div>
</div>

<!-- –ú–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∏ –∏ –†–µ–≥–∏–æ–Ω—ã -->
<div class="card">
    <div class="card-header">
        <div class="card-title">üìç –ì–æ—Ä–æ–¥–∞-–º–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∏ –∏ —Ä–µ–≥–∏–æ–Ω—ã</div>
        <span class="text-muted" style="font-size: 0.875rem;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–∞–ª–æ–Ω—ã</span>
    </div>
    
    <table>
        <thead>
            <tr>
                <th style="width: 40px;"></th>
                <th>–ì–æ—Ä–æ–¥ / –†–µ–≥–∏–æ–Ω</th>
                <th style="text-align: right;">–°–∞–ª–æ–Ω–æ–≤</th>
                <th style="text-align: right;">–í—ã—Ä—É—á–∫–∞</th>
            </tr>
        </thead>
        <tbody>
            <!-- –ì–æ—Ä–æ–¥–∞-–º–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∏ -->
            {% if geo.millionniki %}
            <tr style="background: var(--accent-light);">
                <td colspan="4" style="font-weight: 600; color: var(--accent); padding: 0.5rem 1rem;">
                    üèô –ì–æ—Ä–æ–¥–∞-–º–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∏
                </td>
            </tr>
            {% for city in geo.millionniki %}
            <tr class="expandable-row" onclick="toggleSalons('millionnik-{{ loop.index }}', this)">
                <td><span class="expand-icon">‚ñ∂</span></td>
                <td style="font-weight: 500;">{{ city.name }}</td>
                <td style="text-align: right;">
                    <span class="badge badge-verified">{{ city.count }}</span>
                </td>
                <td style="text-align: right; color: var(--success); font-weight: 500;">
                    {{ "{:,.0f}".format(city.revenue).replace(",", " ") }} ‚ÇΩ
                </td>
            </tr>
            <tr>
                <td colspan="4" style="padding: 0;">
                    <div id="millionnik-{{ loop.index }}" class="salons-list">
                        {% for salon in city.salons %}
                        <div class="salon-item">
                            <span class="salon-rank">#{{ salon.rank }}</span>
                            <span class="salon-name">{{ salon.name }}</span>
                            <span class="salon-revenue">{{ "{:,.0f}".format(salon.revenue).replace(",", " ") }} ‚ÇΩ</span>
                        </div>
                        {% endfor %}
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% endif %}
            
            <!-- –†–µ–≥–∏–æ–Ω—ã/–û–±–ª–∞—Å—Ç–∏ -->
            {% if geo.regions %}
            <tr style="background: var(--warning-light);">
                <td colspan="4" style="font-weight: 600; color: #b45309; padding: 0.5rem 1rem; margin-top: 1rem;">
                    üó∫ –†–µ–≥–∏–æ–Ω—ã / –û–±–ª–∞—Å—Ç–∏
                </td>
            </tr>
            {% for region in geo.regions %}
            <tr class="expandable-row" onclick="toggleSalons('region-{{ loop.index }}', this)">
                <td><span class="expand-icon">‚ñ∂</span></td>
                <td style="font-weight: 500;">{{ region.name }}</td>
                <td style="text-align: right;">
                    <span class="badge badge-warning">{{ region.count }}</span>
                </td>
                <td style="text-align: right; color: var(--success); font-weight: 500;">
                    {{ "{:,.0f}".format(region.revenue).replace(",", " ") }} ‚ÇΩ
                </td>
            </tr>
            <tr>
                <td colspan="4" style="padding: 0;">
                    <div id="region-{{ loop.index }}" class="salons-list">
                        {% for salon in region.salons %}
                        <div class="salon-item">
                            <span class="salon-rank">#{{ salon.rank }}</span>
                            <span class="salon-name">{{ salon.name }}</span>
                            <span class="salon-revenue">{{ "{:,.0f}".format(salon.revenue).replace(",", " ") }} ‚ÇΩ</span>
                        </div>
                        {% endfor %}
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>

<!-- –í—ã—Ä—É—á–∫–∞: –º–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∏ vs –æ—Å—Ç–∞–ª—å–Ω—ã–µ -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <div class="card-title">üí∞ –í—ã—Ä—É—á–∫–∞: –º–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∏ vs –¥—Ä—É–≥–∏–µ –≥–æ—Ä–æ–¥–∞</div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; padding: 1rem;">
        <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: var(--accent);">
                {{ "{:,.0f}".format(geo.millionniki_revenue).replace(",", " ") }} ‚ÇΩ
            </div>
            <div style="color: var(--text-muted); margin-top: 0.5rem;">
                –í—ã—Ä—É—á–∫–∞ –≤ –º–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∞—Ö
                {% if geo.millionniki_revenue + geo.other_revenue > 0 %}
                ({{ "%.1f"|format(geo.millionniki_revenue / (geo.millionniki_revenue + geo.other_revenue) * 100) }}%)
                {% endif %}
            </div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: var(--warning);">
                {{ "{:,.0f}".format(geo.other_revenue).replace(",", " ") }} ‚ÇΩ
            </div>
            <div style="color: var(--text-muted); margin-top: 0.5rem;">
                –í—ã—Ä—É—á–∫–∞ –≤ –¥—Ä—É–≥–∏—Ö –≥–æ—Ä–æ–¥–∞—Ö
                {% if geo.millionniki_revenue + geo.other_revenue > 0 %}
                ({{ "%.1f"|format(geo.other_revenue / (geo.millionniki_revenue + geo.other_revenue) * 100) }}%)
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if geo.unknown_cities %}
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <div class="card-title">‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥ ({{ geo.unknown_cities|length }})</div>
    </div>
    <div style="padding: 1rem; color: var(--text-muted); font-size: 0.875rem;">
        {% for name in geo.unknown_cities[:10] %}
        <code style="margin-right: 0.5rem; margin-bottom: 0.5rem; display: inline-block;">{{ name }}</code>
        {% endfor %}
        {% if geo.unknown_cities|length > 10 %}
        <span>... –∏ –µ—â—ë {{ geo.unknown_cities|length - 10 }}</span>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
function toggleSalons(id, row) {
    const list = document.getElementById(id);
    const icon = row.querySelector('.expand-icon');
    
    if (list.classList.contains('show')) {
        list.classList.remove('show');
        icon.classList.remove('expanded');
    } else {
        list.classList.add('show');
        icon.classList.add('expanded');
    }
}
</script>
{% endblock %}
