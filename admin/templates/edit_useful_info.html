{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî {{ dept_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/useful-info" class="btn btn-secondary">&larr; –ù–∞–∑–∞–¥</a>
    <h1>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</h1>
</div>

<div class="edit-info">
    <span class="dept-badge">{{ dept_name }}</span>
    <span class="type-badge">{{ type_name }}</span>
</div>

<div class="form-container">
    <form action="/useful-info/{{ department.value }}/{{ info_type.value }}/edit" method="post" id="infoForm">
        <div class="form-group">
            <label class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
            
            <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
            <div class="editor-toolbar">
                <button type="button" onclick="formatText('bold')" title="–ñ–∏—Ä–Ω—ã–π (Ctrl+B)">
                    <strong>B</strong>
                </button>
                <button type="button" onclick="formatText('italic')" title="–ö—É—Ä—Å–∏–≤ (Ctrl+I)">
                    <em>I</em>
                </button>
                <button type="button" onclick="formatText('underline')" title="–ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π (Ctrl+U)">
                    <u>U</u>
                </button>
                <button type="button" onclick="formatText('code')" title="–ö–æ–¥">
                    &lt;/&gt;
                </button>
                <div class="toolbar-divider"></div>
                <button type="button" onclick="toggleEmojiPicker()" title="–≠–º–æ–¥–∑–∏" id="emojiBtn">
                    üòä
                </button>
            </div>
            
            <!-- –ü–∏–∫–µ—Ä —ç–º–æ–¥–∑–∏ -->
            <div id="emojiPicker" class="emoji-picker" style="display: none;">
                <div class="emoji-grid">
                    <span onclick="insertEmoji('üòä')">üòä</span>
                    <span onclick="insertEmoji('üòÉ')">üòÉ</span>
                    <span onclick="insertEmoji('üëç')">üëç</span>
                    <span onclick="insertEmoji('üëè')">üëè</span>
                    <span onclick="insertEmoji('üí™')">üí™</span>
                    <span onclick="insertEmoji('‚úÖ')">‚úÖ</span>
                    <span onclick="insertEmoji('‚ùå')">‚ùå</span>
                    <span onclick="insertEmoji('‚ö†Ô∏è')">‚ö†Ô∏è</span>
                    <span onclick="insertEmoji('üì¢')">üì¢</span>
                    <span onclick="insertEmoji('üîî')">üîî</span>
                    <span onclick="insertEmoji('üìå')">üìå</span>
                    <span onclick="insertEmoji('üí°')">üí°</span>
                    <span onclick="insertEmoji('‚≠ê')">‚≠ê</span>
                    <span onclick="insertEmoji('‚ú®')">‚ú®</span>
                    <span onclick="insertEmoji('üéâ')">üéâ</span>
                    <span onclick="insertEmoji('üèÜ')">üèÜ</span>
                    <span onclick="insertEmoji('üí∞')">üí∞</span>
                    <span onclick="insertEmoji('üìà')">üìà</span>
                    <span onclick="insertEmoji('üìä')">üìä</span>
                    <span onclick="insertEmoji('üóì')">üóì</span>
                    <span onclick="insertEmoji('‚è∞')">‚è∞</span>
                    <span onclick="insertEmoji('üì±')">üì±</span>
                    <span onclick="insertEmoji('üìß')">üìß</span>
                    <span onclick="insertEmoji('üìû')">üìû</span>
                    <span onclick="insertEmoji('üè¢')">üè¢</span>
                    <span onclick="insertEmoji('üöÄ')">üöÄ</span>
                    <span onclick="insertEmoji('üì¢')">üì¢</span>
                    <span onclick="insertEmoji('üé®')">üé®</span>
                    <span onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                    <span onclick="insertEmoji('üîó')">üîó</span>
                </div>
            </div>
            
            <!-- –†–µ–¥–∞–∫—Ç–æ—Ä -->
            <div id="textEditor" class="text-editor" contenteditable="true" 
                 placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></div>
            
            <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <input type="hidden" name="text" id="textInput">
            
            <small class="editor-hint">
                –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. 
                –î–ª—è —Å—Å—ã–ª–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: –≤—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç ‚Üí Ctrl+K –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é &lt;a href="URL"&gt;—Ç–µ–∫—Å—Ç&lt;/a&gt;
            </small>
        </div>
        
        <div class="form-actions">
            <a href="/useful-info" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
            <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </form>
</div>

<style>
.page-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.page-header h1 {
    margin: 0;
}

.edit-info {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.dept-badge, .type-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.dept-badge {
    background: var(--accent-light);
    color: var(--accent);
}

.type-badge {
    background: var(--bg-dark);
    color: var(--text);
}

.form-container {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 2rem;
    max-width: 800px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.editor-toolbar {
    display: flex;
    gap: 0.25rem;
    padding: 0.5rem;
    background: var(--bg-main);
    border: 1px solid var(--border);
    border-bottom: none;
    border-radius: 10px 10px 0 0;
}

.editor-toolbar button {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--bg-card);
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.editor-toolbar button:hover {
    background: var(--accent-light);
    color: var(--accent);
}

.toolbar-divider {
    width: 1px;
    background: var(--border);
    margin: 0 0.5rem;
}

.text-editor {
    min-height: 200px;
    padding: 1rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 0 0 10px 10px;
    font-size: 0.9375rem;
    line-height: 1.6;
    outline: none;
}

.text-editor:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-light);
}

.text-editor:empty:before {
    content: attr(placeholder);
    color: var(--text-muted);
}

.text-editor b, .text-editor strong { font-weight: 700; }
.text-editor i, .text-editor em { font-style: italic; }
.text-editor u { text-decoration: underline; }
.text-editor code { 
    background: var(--bg-main); 
    padding: 0.125rem 0.375rem; 
    border-radius: 4px;
    font-family: monospace;
}
.text-editor a {
    color: var(--accent);
    text-decoration: underline;
}

.emoji-picker {
    display: inline-block;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-top: 0.25rem;
    margin-bottom: 0.5rem;
}

.emoji-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0;
    max-width: 270px;
}

.emoji-grid span {
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.125rem;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.1s;
}

.emoji-grid span:hover {
    background: var(--accent-light);
}

.editor-hint {
    display: block;
    margin-top: 0.5rem;
    color: var(--text-muted);
    font-size: 0.8rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
}
</style>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ç–µ–∫—Å—Ç–æ–º
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('textEditor');
    const existingText = `{{ info.text|safe if info else '' }}`;
    if (existingText) {
        editor.innerHTML = existingText;
    }
});

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
function formatText(type) {
    const editor = document.getElementById('textEditor');
    editor.focus();
    
    const selection = window.getSelection();
    if (!selection.rangeCount) return;
    
    const range = selection.getRangeAt(0);
    const selectedText = range.toString();
    
    if (!selectedText) return;
    
    let tag;
    switch(type) {
        case 'bold': tag = 'b'; break;
        case 'italic': tag = 'i'; break;
        case 'underline': tag = 'u'; break;
        case 'code': tag = 'code'; break;
        default: return;
    }
    
    const wrapper = document.createElement(tag);
    range.surroundContents(wrapper);
    
    selection.removeAllRanges();
}

// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
document.addEventListener('keydown', function(e) {
    if (e.target.id !== 'textEditor') return;
    
    if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
            case 'b':
                e.preventDefault();
                formatText('bold');
                break;
            case 'i':
                e.preventDefault();
                formatText('italic');
                break;
            case 'u':
                e.preventDefault();
                formatText('underline');
                break;
        }
    }
});

// –≠–º–æ–¥–∑–∏ –ø–∏–∫–µ—Ä
function toggleEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
}

function insertEmoji(emoji) {
    const editor = document.getElementById('textEditor');
    editor.focus();
    
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    
    const textNode = document.createTextNode(emoji);
    range.insertNode(textNode);
    range.setStartAfter(textNode);
    range.setEndAfter(textNode);
    selection.removeAllRanges();
    selection.addRange(range);
    
    document.getElementById('emojiPicker').style.display = 'none';
}

// –ó–∞–∫—Ä—ã—Ç—å —ç–º–æ–¥–∑–∏ –ø–∏–∫–µ—Ä –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
document.addEventListener('click', function(e) {
    const picker = document.getElementById('emojiPicker');
    const btn = document.getElementById('emojiBtn');
    if (picker && !picker.contains(e.target) && e.target !== btn) {
        picker.style.display = 'none';
    }
});

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ HTML –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
document.getElementById('infoForm').addEventListener('submit', function(e) {
    const editor = document.getElementById('textEditor');
    const input = document.getElementById('textInput');
    
    // –ü–æ–ª—É—á–∞–µ–º HTML –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–≥–∏
    let html = editor.innerHTML;
    
    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ div/br –æ—Ç contenteditable
    html = html.replace(/<div>/gi, '\n').replace(/<\/div>/gi, '');
    html = html.replace(/<br\s*\/?>/gi, '\n');
    
    // –ó–∞–º–µ–Ω—è–µ–º strong –Ω–∞ b, em –Ω–∞ i
    html = html.replace(/<strong>/gi, '<b>').replace(/<\/strong>/gi, '</b>');
    html = html.replace(/<em>/gi, '<i>').replace(/<\/em>/gi, '</i>');
    
    // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
    html = html.trim();
    
    if (!html) {
        e.preventDefault();
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
    }
    
    input.value = html;
});
</script>
{% endblock %}
