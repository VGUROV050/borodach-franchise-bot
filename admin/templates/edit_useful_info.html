{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî {{ dept_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/useful-info" class="btn btn-secondary">&larr; –ù–∞–∑–∞–¥</a>
    <h1>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</h1>
</div>

<div class="edit-info">
    <span class="dept-badge">{{ dept_name }}</span>
    <span class="type-badge">{{ type_name }}</span>
</div>

<div class="editor-container">
    <form action="/useful-info/{{ department.value }}/{{ info_type.value }}/edit" method="post" id="infoForm">
        
        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
        <div class="editor-panel">
            <div class="panel-header">
                <span>üìù –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</span>
                
                <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
                <div class="toolbar">
                    <button type="button" onclick="insertTag('b')" title="–ñ–∏—Ä–Ω—ã–π">
                        <strong>B</strong>
                    </button>
                    <button type="button" onclick="insertTag('i')" title="–ö—É—Ä—Å–∏–≤">
                        <em>I</em>
                    </button>
                    <button type="button" onclick="insertTag('u')" title="–ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π">
                        <u>U</u>
                    </button>
                    <button type="button" onclick="insertTag('code')" title="–ö–æ–¥">
                        &lt;/&gt;
                    </button>
                    <button type="button" onclick="insertLink()" title="–°—Å—ã–ª–∫–∞">
                        üîó
                    </button>
                    <div class="toolbar-divider"></div>
                    <div class="emoji-dropdown">
                        <button type="button" onclick="toggleEmoji()" id="emojiBtn">üòä</button>
                        <div class="emoji-panel" id="emojiPanel">
                            <span onclick="insertEmoji('üòä')">üòä</span>
                            <span onclick="insertEmoji('üëç')">üëç</span>
                            <span onclick="insertEmoji('‚úÖ')">‚úÖ</span>
                            <span onclick="insertEmoji('‚ùå')">‚ùå</span>
                            <span onclick="insertEmoji('‚ö†Ô∏è')">‚ö†Ô∏è</span>
                            <span onclick="insertEmoji('üì¢')">üì¢</span>
                            <span onclick="insertEmoji('üîî')">üîî</span>
                            <span onclick="insertEmoji('üìå')">üìå</span>
                            <span onclick="insertEmoji('üí°')">üí°</span>
                            <span onclick="insertEmoji('‚≠ê')">‚≠ê</span>
                            <span onclick="insertEmoji('üéâ')">üéâ</span>
                            <span onclick="insertEmoji('üèÜ')">üèÜ</span>
                            <span onclick="insertEmoji('üí∞')">üí∞</span>
                            <span onclick="insertEmoji('üìà')">üìà</span>
                            <span onclick="insertEmoji('üìû')">üìû</span>
                            <span onclick="insertEmoji('üöÄ')">üöÄ</span>
                            <span onclick="insertEmoji('üé®')">üé®</span>
                            <span onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            <span onclick="insertEmoji('üîó')">üîó</span>
                            <span onclick="insertEmoji('üìã')">üìã</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <textarea id="textArea" name="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...">{{ info.text if info else '' }}</textarea>
            
            <div class="editor-hint">
                –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç ‚Üí –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
                –ò–ª–∏ –ø–∏—à–∏—Ç–µ —Ç–µ–≥–∏ –≤—Ä—É—á–Ω—É—é: &lt;b&gt;–∂–∏—Ä–Ω—ã–π&lt;/b&gt;
            </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ø—Ä–µ–≤—å—é -->
        <div class="preview-panel">
            <div class="panel-header">
                <span>üëÅ –ü—Ä–µ–≤—å—é (–∫–∞–∫ –≤ Telegram)</span>
            </div>
            <div class="preview-content" id="preview"></div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É -->
        <div class="form-actions">
            <a href="/useful-info" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
            <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </form>
</div>

<style>
.page-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.page-header h1 {
    margin: 0;
}

.edit-info {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.dept-badge, .type-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.dept-badge {
    background: var(--accent-light);
    color: var(--accent);
}

.type-badge {
    background: var(--bg-dark);
    color: var(--text);
}

.editor-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    max-width: 1200px;
}

.editor-container form {
    display: contents;
}

.editor-panel, .preview-panel {
    background: var(--bg-card);
    border-radius: 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: var(--bg-main);
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    font-size: 0.9rem;
}

.toolbar {
    display: flex;
    gap: 0.25rem;
    align-items: center;
}

.toolbar button {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--bg-card);
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.toolbar button:hover {
    background: var(--accent-light);
    color: var(--accent);
}

.toolbar-divider {
    width: 1px;
    height: 24px;
    background: var(--border);
    margin: 0 0.5rem;
}

.emoji-dropdown {
    position: relative;
}

.emoji-panel {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.25rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.5rem;
    box-shadow: var(--shadow-lg);
    z-index: 100;
    width: 200px;
}

.emoji-panel.show {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
}

.emoji-panel span {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 4px;
    font-size: 1rem;
}

.emoji-panel span:hover {
    background: var(--accent-light);
}

#textArea {
    flex: 1;
    min-height: 300px;
    padding: 1rem;
    border: none;
    font-family: 'SF Mono', 'Menlo', 'Monaco', monospace;
    font-size: 0.9rem;
    line-height: 1.6;
    resize: none;
    outline: none;
}

#textArea:focus {
    background: #fafbfc;
}

.editor-hint {
    padding: 0.5rem 1rem;
    background: var(--bg-main);
    border-top: 1px solid var(--border);
    font-size: 0.75rem;
    color: var(--text-muted);
}

.preview-content {
    flex: 1;
    padding: 1rem;
    font-size: 0.9375rem;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
    overflow-y: auto;
    min-height: 300px;
}

.preview-content:empty::before {
    content: '–ü—Ä–µ–≤—å—é –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...';
    color: var(--text-muted);
    font-style: italic;
}

.preview-content b { font-weight: 700; }
.preview-content i { font-style: italic; }
.preview-content u { text-decoration: underline; }
.preview-content code { 
    background: var(--bg-main); 
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.85em;
}
.preview-content a {
    color: var(--accent);
    text-decoration: underline;
}

.form-actions {
    grid-column: 1 / -1;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding-top: 1rem;
}

@media (max-width: 900px) {
    .editor-container {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
const textarea = document.getElementById('textArea');
const preview = document.getElementById('preview');

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
function updatePreview() {
    let html = textarea.value;
    
    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML –∫—Ä–æ–º–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤
    // (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ Telegram —Å–∞–º —ç—Ç–æ —Å–¥–µ–ª–∞–µ—Ç)
    
    preview.innerHTML = html || '';
}

textarea.addEventListener('input', updatePreview);
updatePreview();

// –í—Å—Ç–∞–≤–∫–∞ —Ç–µ–≥–∞ –≤–æ–∫—Ä—É–≥ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
function insertTag(tag) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selected = text.substring(start, end);
    
    if (selected) {
        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        const newText = text.substring(0, start) + 
                       `<${tag}>${selected}</${tag}>` + 
                       text.substring(end);
        textarea.value = newText;
        
        // –°—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ
        const newPos = start + tag.length + 2 + selected.length + tag.length + 3;
        textarea.setSelectionRange(newPos, newPos);
    } else {
        // –í—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π —Ç–µ–≥ –∏ —Å—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –≤–Ω—É—Ç—Ä—å
        const newText = text.substring(0, start) + 
                       `<${tag}></${tag}>` + 
                       text.substring(end);
        textarea.value = newText;
        
        const newPos = start + tag.length + 2;
        textarea.setSelectionRange(newPos, newPos);
    }
    
    textarea.focus();
    updatePreview();
}

// –í—Å—Ç–∞–≤–∫–∞ —Å—Å—ã–ª–∫–∏
function insertLink() {
    const url = prompt('–í–≤–µ–¥–∏—Ç–µ URL:', 'https://');
    if (!url) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selected = text.substring(start, end) || '—Å—Å—ã–ª–∫–∞';
    
    const newText = text.substring(0, start) + 
                   `<a href="${url}">${selected}</a>` + 
                   text.substring(end);
    textarea.value = newText;
    
    textarea.focus();
    updatePreview();
}

// –≠–º–æ–¥–∑–∏
function toggleEmoji() {
    document.getElementById('emojiPanel').classList.toggle('show');
}

function insertEmoji(emoji) {
    const start = textarea.selectionStart;
    const text = textarea.value;
    
    textarea.value = text.substring(0, start) + emoji + text.substring(start);
    textarea.setSelectionRange(start + emoji.length, start + emoji.length);
    
    textarea.focus();
    document.getElementById('emojiPanel').classList.remove('show');
    updatePreview();
}

// –ó–∞–∫—Ä—ã—Ç—å —ç–º–æ–¥–∑–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
document.addEventListener('click', function(e) {
    const panel = document.getElementById('emojiPanel');
    const btn = document.getElementById('emojiBtn');
    if (!panel.contains(e.target) && e.target !== btn) {
        panel.classList.remove('show');
    }
});

// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
textarea.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
            case 'b':
                e.preventDefault();
                insertTag('b');
                break;
            case 'i':
                e.preventDefault();
                insertTag('i');
                break;
            case 'u':
                e.preventDefault();
                insertTag('u');
                break;
        }
    }
});
</script>
{% endblock %}
