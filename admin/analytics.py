# Analytics helpers for admin panel

import re
from collections import defaultdict
from typing import Optional

# Города-миллионники России (население > 1 млн)
MILLIONNIKI = {
    "москва", "санкт-петербург", "спб", "питер", "петербург",
    "новосибирск", "екатеринбург", "казань", "нижний новгород",
    "красноярск", "челябинск", "самара", "уфа", "ростов-на-дону",
    "ростов", "омск", "краснодар", "воронеж", "пермь", "волгоград",
}

# Маппинг город -> область/регион
CITY_TO_REGION = {
    # Москва и МО
    "москва": "Москва",
    "мо": "Московская область",
    "московская область": "Московская область",
    "подмосковье": "Московская область",
    "химки": "Московская область",
    "мытищи": "Московская область",
    "балашиха": "Московская область",
    "королёв": "Московская область",
    "королев": "Московская область",
    "люберцы": "Московская область",
    "красногорск": "Московская область",
    "одинцово": "Московская область",
    "домодедово": "Московская область",
    "раменское": "Московская область",
    "долгопрудный": "Московская область",
    "реутов": "Московская область",
    "жуковский": "Московская область",
    "пушкино": "Московская область",
    "сергиев посад": "Московская область",
    "щёлково": "Московская область",
    "щелково": "Московская область",
    "видное": "Московская область",
    "подольск": "Московская область",
    "ногинск": "Московская область",
    "электросталь": "Московская область",
    "серпухов": "Московская область",
    "орехово-зуево": "Московская область",
    "коломна": "Московская область",
    
    # Санкт-Петербург и ЛО
    "санкт-петербург": "Санкт-Петербург",
    "спб": "Санкт-Петербург",
    "питер": "Санкт-Петербург",
    "петербург": "Санкт-Петербург",
    "ленинградская область": "Ленинградская область",
    "гатчина": "Ленинградская область",
    "выборг": "Ленинградская область",
    
    # Другие области
    "воронеж": "Воронежская область",
    "тула": "Тульская область",
    "рязань": "Рязанская область",
    "калуга": "Калужская область",
    "тверь": "Тверская область",
    "ярославль": "Ярославская область",
    "владимир": "Владимирская область",
    "иваново": "Ивановская область",
    "кострома": "Костромская область",
    "орёл": "Орловская область",
    "орел": "Орловская область",
    "курск": "Курская область",
    "белгород": "Белгородская область",
    "липецк": "Липецкая область",
    "тамбов": "Тамбовская область",
    "брянск": "Брянская область",
    "смоленск": "Смоленская область",
    
    "калининград": "Калининградская область",
    "мурманск": "Мурманская область",
    "архангельск": "Архангельская область",
    "вологда": "Вологодская область",
    "псков": "Псковская область",
    "новгород": "Новгородская область",
    "великий новгород": "Новгородская область",
    
    "ростов-на-дону": "Ростовская область",
    "ростов": "Ростовская область",
    "краснодар": "Краснодарский край",
    "сочи": "Краснодарский край",
    "новороссийск": "Краснодарский край",
    "волгоград": "Волгоградская область",
    "астрахань": "Астраханская область",
    "севастополь": "Крым",
    "симферополь": "Крым",
    "крым": "Крым",
    
    "казань": "Татарстан",
    "набережные челны": "Татарстан",
    "нижний новгород": "Нижегородская область",
    "самара": "Самарская область",
    "тольятти": "Самарская область",
    "уфа": "Башкортостан",
    "пермь": "Пермский край",
    "саратов": "Саратовская область",
    "ижевск": "Удмуртия",
    "ульяновск": "Ульяновская область",
    "оренбург": "Оренбургская область",
    "пенза": "Пензенская область",
    "чебоксары": "Чувашия",
    "киров": "Кировская область",
    "йошкар-ола": "Марий Эл",
    "саранск": "Мордовия",
    
    "екатеринбург": "Свердловская область",
    "нижний тагил": "Свердловская область",
    "челябинск": "Челябинская область",
    "магнитогорск": "Челябинская область",
    "тюмень": "Тюменская область",
    "курган": "Курганская область",
    "сургут": "ХМАО",
    "нижневартовск": "ХМАО",
    "ханты-мансийск": "ХМАО",
    
    "новосибирск": "Новосибирская область",
    "красноярск": "Красноярский край",
    "омск": "Омская область",
    "барнаул": "Алтайский край",
    "иркутск": "Иркутская область",
    "томск": "Томская область",
    "кемерово": "Кемеровская область",
    "новокузнецк": "Кемеровская область",
    
    "владивосток": "Приморский край",
    "хабаровск": "Хабаровский край",
    "якутск": "Якутия",
    "благовещенск": "Амурская область",
    "чита": "Забайкальский край",
    "улан-удэ": "Бурятия",
    
    "ставрополь": "Ставропольский край",
    "пятигорск": "Ставропольский край",
    "махачкала": "Дагестан",
    "грозный": "Чечня",
}


def extract_city_from_name(salon_name: str) -> Optional[str]:
    """
    Извлечь название города из названия салона.
    Форматы:
    - "Москва - Арбатская" -> Москва
    - "Казань, ТЦ Мега" -> Казань
    - "Нижний Новгород - Горьковская" -> Нижний Новгород
    """
    if not salon_name:
        return None
    
    # Убираем лишние пробелы
    name = salon_name.strip()
    
    # Вариант 1: "Москва — м. Преображенская" (длинное тире)
    if " — " in name:
        city = name.split(" — ")[0].strip()
        return city
    
    # Вариант 2: "Москва - метро" (короткое тире с пробелами)
    if " - " in name:
        city = name.split(" - ")[0].strip()
        return city
    
    # Вариант 2: "Москва-метро" (без пробелов вокруг дефиса)
    # Но это может быть "Ростов-на-Дону", поэтому проверяем осторожно
    if "-" in name and " " in name.split("-")[0]:
        # Если до дефиса есть пробел, значит формат другой
        pass
    elif "-" in name:
        # Проверяем не составное ли это название города
        first_part = name.split("-")[0].strip()
        if first_part.lower() not in ["ростов", "нижний", "набережные", "йошкар", "санкт", "петропавловск", "южно", "горно", "орехово"]:
            return first_part
    
    # Вариант 3: "Москва, ТЦ Авиапарк" -> берём до запятой
    if "," in name:
        city = name.split(",")[0].strip()
        return city
    
    # Вариант 4: "Москва ТЦ Авиапарк" -> берём первое слово (или два если "Нижний Новгород")
    words = name.split()
    if len(words) >= 2:
        # Проверяем составные названия городов
        two_words = f"{words[0]} {words[1]}".lower()
        known_two_word_cities = [
            "нижний новгород", "набережные челны", "йошкар-ола", "йошкар ола",
            "санкт-петербург", "санкт петербург", "ростов-на-дону", "великий новгород",
            "нижний тагил", "сергиев посад", "орехово-зуево"
        ]
        if two_words in known_two_word_cities or two_words in CITY_TO_REGION:
            return f"{words[0]} {words[1]}"
        
        # Проверяем трёхсловные
        if len(words) >= 3:
            three_words = f"{words[0]} {words[1]} {words[2]}".lower()
            if three_words == "ростов на дону" or three_words == "ростов-на-дону":
                return "Ростов-на-Дону"
    
    if words:
        return words[0]
    
    return None


def is_millionnik(city: str) -> bool:
    """Проверить является ли город миллионником."""
    if not city:
        return False
    return city.lower().strip() in MILLIONNIKI


def get_region(city: str) -> str:
    """Получить регион (федеральный округ) по городу."""
    if not city:
        return "Не определено"
    
    city_lower = city.lower().strip()
    
    # Прямое совпадение
    if city_lower in CITY_TO_REGION:
        return CITY_TO_REGION[city_lower]
    
    # Частичное совпадение (для случаев типа "Москва Север")
    for known_city, region in CITY_TO_REGION.items():
        if known_city in city_lower or city_lower in known_city:
            return region
    
    return "Не определено"


def analyze_geography(ratings: list) -> dict:
    """
    Проанализировать географию сети по данным рейтинга.
    
    Returns:
        {
            "total_salons": int,
            "millionniki_count": int,
            "millionniki_percent": float,
            "other_count": int,
            "by_city": {"Москва": {"count": 10, "revenue": 1000000}, ...},
            "by_region": {"Центральный ФО": {"count": 20, "revenue": 5000000}, ...},
            "unknown_cities": ["Непонятное название", ...]
        }
    """
    result = {
        "total_salons": len(ratings),
        "millionniki_count": 0,
        "millionniki_revenue": 0,
        "other_count": 0,
        "other_revenue": 0,
        "by_city": defaultdict(lambda: {"count": 0, "revenue": 0, "avg_check": 0}),
        "by_region": defaultdict(lambda: {"count": 0, "revenue": 0}),
        "unknown_cities": [],
    }
    
    for r in ratings:
        city = extract_city_from_name(r.company_name)
        revenue = r.revenue or 0
        avg_check = getattr(r, 'avg_check', 0) or 0
        
        if city:
            # По городам
            result["by_city"][city]["count"] += 1
            result["by_city"][city]["revenue"] += revenue
            # Средний чек - берём среднее
            if avg_check > 0:
                current_avg = result["by_city"][city]["avg_check"]
                current_count = result["by_city"][city]["count"]
                result["by_city"][city]["avg_check"] = (
                    (current_avg * (current_count - 1) + avg_check) / current_count
                )
            
            # По регионам
            region = get_region(city)
            result["by_region"][region]["count"] += 1
            result["by_region"][region]["revenue"] += revenue
            
            # Миллионники vs остальные
            if is_millionnik(city):
                result["millionniki_count"] += 1
                result["millionniki_revenue"] += revenue
            else:
                result["other_count"] += 1
                result["other_revenue"] += revenue
        else:
            result["unknown_cities"].append(r.company_name)
            result["other_count"] += 1
            result["other_revenue"] += revenue
    
    # Вычисляем проценты
    total = result["total_salons"]
    if total > 0:
        result["millionniki_percent"] = round(result["millionniki_count"] / total * 100, 1)
        result["other_percent"] = round(result["other_count"] / total * 100, 1)
    else:
        result["millionniki_percent"] = 0
        result["other_percent"] = 0
    
    # Конвертируем defaultdict в обычный dict для сортировки
    result["by_city"] = dict(sorted(
        result["by_city"].items(), 
        key=lambda x: x[1]["count"], 
        reverse=True
    ))
    result["by_region"] = dict(sorted(
        result["by_region"].items(), 
        key=lambda x: x[1]["count"], 
        reverse=True
    ))
    
    return result

