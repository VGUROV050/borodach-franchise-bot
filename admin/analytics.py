# Analytics helpers for admin panel

import re
from collections import defaultdict
from typing import Optional

# Города-миллионники России (население > 1 млн)
MILLIONNIKI = {
    "москва", "санкт-петербург", "спб", "питер", "петербург",
    "новосибирск", "екатеринбург", "казань", "нижний новгород",
    "красноярск", "челябинск", "самара", "уфа", "ростов-на-дону",
    "ростов", "омск", "краснодар", "воронеж", "пермь", "волгоград",
}

# Маппинг город -> регион (федеральный округ)
CITY_TO_REGION = {
    # Центральный ФО
    "москва": "Центральный ФО",
    "московская область": "Центральный ФО",
    "мо": "Центральный ФО",
    "подмосковье": "Центральный ФО",
    "воронеж": "Центральный ФО",
    "тула": "Центральный ФО",
    "рязань": "Центральный ФО",
    "калуга": "Центральный ФО",
    "тверь": "Центральный ФО",
    "ярославль": "Центральный ФО",
    "владимир": "Центральный ФО",
    "иваново": "Центральный ФО",
    "кострома": "Центральный ФО",
    "орёл": "Центральный ФО",
    "орел": "Центральный ФО",
    "курск": "Центральный ФО",
    "белгород": "Центральный ФО",
    "липецк": "Центральный ФО",
    "тамбов": "Центральный ФО",
    "брянск": "Центральный ФО",
    "смоленск": "Центральный ФО",
    
    # Северо-Западный ФО
    "санкт-петербург": "Северо-Западный ФО",
    "спб": "Северо-Западный ФО",
    "питер": "Северо-Западный ФО",
    "петербург": "Северо-Западный ФО",
    "калининград": "Северо-Западный ФО",
    "мурманск": "Северо-Западный ФО",
    "архангельск": "Северо-Западный ФО",
    "вологда": "Северо-Западный ФО",
    "псков": "Северо-Западный ФО",
    "новгород": "Северо-Западный ФО",
    "великий новгород": "Северо-Западный ФО",
    "петрозаводск": "Северо-Западный ФО",
    "сыктывкар": "Северо-Западный ФО",
    
    # Южный ФО
    "ростов-на-дону": "Южный ФО",
    "ростов": "Южный ФО",
    "краснодар": "Южный ФО",
    "волгоград": "Южный ФО",
    "астрахань": "Южный ФО",
    "сочи": "Южный ФО",
    "новороссийск": "Южный ФО",
    "элиста": "Южный ФО",
    "майкоп": "Южный ФО",
    "севастополь": "Южный ФО",
    "симферополь": "Южный ФО",
    "крым": "Южный ФО",
    
    # Приволжский ФО
    "казань": "Приволжский ФО",
    "нижний новгород": "Приволжский ФО",
    "самара": "Приволжский ФО",
    "уфа": "Приволжский ФО",
    "пермь": "Приволжский ФО",
    "саратов": "Приволжский ФО",
    "тольятти": "Приволжский ФО",
    "ижевск": "Приволжский ФО",
    "ульяновск": "Приволжский ФО",
    "оренбург": "Приволжский ФО",
    "пенза": "Приволжский ФО",
    "набережные челны": "Приволжский ФО",
    "чебоксары": "Приволжский ФО",
    "киров": "Приволжский ФО",
    "йошкар-ола": "Приволжский ФО",
    "саранск": "Приволжский ФО",
    
    # Уральский ФО
    "екатеринбург": "Уральский ФО",
    "челябинск": "Уральский ФО",
    "тюмень": "Уральский ФО",
    "магнитогорск": "Уральский ФО",
    "нижний тагил": "Уральский ФО",
    "курган": "Уральский ФО",
    "сургут": "Уральский ФО",
    "нижневартовск": "Уральский ФО",
    "ханты-мансийск": "Уральский ФО",
    "салехард": "Уральский ФО",
    
    # Сибирский ФО
    "новосибирск": "Сибирский ФО",
    "красноярск": "Сибирский ФО",
    "омск": "Сибирский ФО",
    "барнаул": "Сибирский ФО",
    "иркутск": "Сибирский ФО",
    "томск": "Сибирский ФО",
    "кемерово": "Сибирский ФО",
    "новокузнецк": "Сибирский ФО",
    "абакан": "Сибирский ФО",
    "горно-алтайск": "Сибирский ФО",
    "кызыл": "Сибирский ФО",
    
    # Дальневосточный ФО
    "владивосток": "Дальневосточный ФО",
    "хабаровск": "Дальневосточный ФО",
    "якутск": "Дальневосточный ФО",
    "благовещенск": "Дальневосточный ФО",
    "южно-сахалинск": "Дальневосточный ФО",
    "петропавловск-камчатский": "Дальневосточный ФО",
    "магадан": "Дальневосточный ФО",
    "чита": "Дальневосточный ФО",
    "улан-удэ": "Дальневосточный ФО",
    
    # Северо-Кавказский ФО
    "ставрополь": "Северо-Кавказский ФО",
    "пятигорск": "Северо-Кавказский ФО",
    "владикавказ": "Северо-Кавказский ФО",
    "махачкала": "Северо-Кавказский ФО",
    "грозный": "Северо-Кавказский ФО",
    "нальчик": "Северо-Кавказский ФО",
    "черкесск": "Северо-Кавказский ФО",
    "назрань": "Северо-Кавказский ФО",
}


def extract_city_from_name(salon_name: str) -> Optional[str]:
    """
    Извлечь название города из названия салона.
    Предполагается что город идёт в начале названия.
    """
    if not salon_name:
        return None
    
    # Убираем лишние пробелы
    name = salon_name.strip()
    
    # Пробуем разные разделители
    # Вариант 1: "Москва, ТЦ Авиапарк" -> берём до запятой
    if "," in name:
        city = name.split(",")[0].strip()
        return city
    
    # Вариант 2: "Москва ТЦ Авиапарк" -> берём первое слово (или два если "Нижний Новгород")
    words = name.split()
    if len(words) >= 2:
        # Проверяем составные названия
        two_words = f"{words[0]} {words[1]}".lower()
        if two_words in CITY_TO_REGION or two_words in MILLIONNIKI:
            return f"{words[0]} {words[1]}"
    
    if words:
        return words[0]
    
    return None


def is_millionnik(city: str) -> bool:
    """Проверить является ли город миллионником."""
    if not city:
        return False
    return city.lower().strip() in MILLIONNIKI


def get_region(city: str) -> str:
    """Получить регион (федеральный округ) по городу."""
    if not city:
        return "Не определено"
    
    city_lower = city.lower().strip()
    
    # Прямое совпадение
    if city_lower in CITY_TO_REGION:
        return CITY_TO_REGION[city_lower]
    
    # Частичное совпадение (для случаев типа "Москва Север")
    for known_city, region in CITY_TO_REGION.items():
        if known_city in city_lower or city_lower in known_city:
            return region
    
    return "Не определено"


def analyze_geography(ratings: list) -> dict:
    """
    Проанализировать географию сети по данным рейтинга.
    
    Returns:
        {
            "total_salons": int,
            "millionniki_count": int,
            "millionniki_percent": float,
            "other_count": int,
            "by_city": {"Москва": {"count": 10, "revenue": 1000000}, ...},
            "by_region": {"Центральный ФО": {"count": 20, "revenue": 5000000}, ...},
            "unknown_cities": ["Непонятное название", ...]
        }
    """
    result = {
        "total_salons": len(ratings),
        "millionniki_count": 0,
        "millionniki_revenue": 0,
        "other_count": 0,
        "other_revenue": 0,
        "by_city": defaultdict(lambda: {"count": 0, "revenue": 0, "avg_check": 0}),
        "by_region": defaultdict(lambda: {"count": 0, "revenue": 0}),
        "unknown_cities": [],
    }
    
    for r in ratings:
        city = extract_city_from_name(r.company_name)
        revenue = r.revenue or 0
        avg_check = getattr(r, 'avg_check', 0) or 0
        
        if city:
            # По городам
            result["by_city"][city]["count"] += 1
            result["by_city"][city]["revenue"] += revenue
            # Средний чек - берём среднее
            if avg_check > 0:
                current_avg = result["by_city"][city]["avg_check"]
                current_count = result["by_city"][city]["count"]
                result["by_city"][city]["avg_check"] = (
                    (current_avg * (current_count - 1) + avg_check) / current_count
                )
            
            # По регионам
            region = get_region(city)
            result["by_region"][region]["count"] += 1
            result["by_region"][region]["revenue"] += revenue
            
            # Миллионники vs остальные
            if is_millionnik(city):
                result["millionniki_count"] += 1
                result["millionniki_revenue"] += revenue
            else:
                result["other_count"] += 1
                result["other_revenue"] += revenue
        else:
            result["unknown_cities"].append(r.company_name)
            result["other_count"] += 1
            result["other_revenue"] += revenue
    
    # Вычисляем проценты
    total = result["total_salons"]
    if total > 0:
        result["millionniki_percent"] = round(result["millionniki_count"] / total * 100, 1)
        result["other_percent"] = round(result["other_count"] / total * 100, 1)
    else:
        result["millionniki_percent"] = 0
        result["other_percent"] = 0
    
    # Конвертируем defaultdict в обычный dict для сортировки
    result["by_city"] = dict(sorted(
        result["by_city"].items(), 
        key=lambda x: x[1]["count"], 
        reverse=True
    ))
    result["by_region"] = dict(sorted(
        result["by_region"].items(), 
        key=lambda x: x[1]["count"], 
        reverse=True
    ))
    
    return result

